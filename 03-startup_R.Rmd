# Настройка и старт R-сессии
Старт R-сессии - достаточно сложный процесс, включающий в себя подгрузку переменных окружения, пользовательских скриптов конфигураций сессии, а так же включение различных опций, подгрузка данных и истории предыдущей сессии и т.д.

Томас Лин Пендерсен [нарисовал](https://twitter.com/thomasp85/status/961553618196418560) исчерпывающую схему процесса старта R-сессии:
![](./pics/r_startup.svg)

## Переменные окружения (.Renviron)
Первое, что происходит при старте сессии - это поиск и чтение переменных окружения. В этих переменных обычно хранятся различные пути (к пакетам, к интерпретатору R, к временным файлам), настройки локали (кодировки, форматы даты, времени, валюты и проч), информация о системе и прочее. Нередко в переменных окружения рекомендуется хранить также и различные токены авторизации - таким образом они будут использоваться в R-сессии, но не будут присутствовать в явном виде в скриптах. 

Полный список переменных окружения, которые могут повлиять на R-сессию можно увидеть в документации по пакету `base`, по запросу `?'environment variables'`. Список уже используемых в сессии переменных и их значений можно увидеть с помощью команды `Sys.getenv()`, в том числе и значение конкретной переменной:
```{r 14-startup-R-1 }
# первые пять переменных окружения из списка
Sys.getenv()[1:5]

# смотрим путь к интерпретатору R и пакетам
Sys.getenv(c("R_HOME", "R_LIBS_USER"))
```

В том числе можно и адресно вызвать значения локали с помощью функции `Sys.getlocale()`. В рамках сессии локаль можно изменить с помощью `Sys.setlocale()` (стоит учитывать, что названия локалей  платформозависимы).
```{r 14-startup-R-2 }
# смотрим используемые в сессии параметры локали
Sys.getlocale()
```

Поиск переменных происходит по цепочке (на примере структуры папок Linux, для Windows будут другие адреса):
 - файл, указанный в `R_ENVIRON` или `R_HOME/etc/Renviron.site`.  Переменные окружения, которые используются для всех пользователей рабочей станции
 
 - файл, указанный в `R_ENVIRON_USER` или  `.Renviron`, находящийся в папке проекта: набор переменных окружения и их возможных кастомных значений, которые используются в этом проекте (например, токены авторизации)
 
 - файл `/home/.Renviron`, находящийся в папке пользователя: набор переменных окружения и их возможных кастомных значений, которые используются во всех проектах этого пользователя
 
Если файлы `.Renviron` отсутствуют и в `R_ENVIRON/R_ENVIRON_USER` ничего не указано, то используются переменные, указанные в `R_HOME/etc/Renviron.site`. При необходимости можно создать свой файл `.Renviron` (стоит учитывать, что если есть `.Renviron` проекта, то `.Renviron` пользователя будет проигнорирован, так как он ниже в иерархии процесса загрузки). Формат файла простой - пара `VARIABLE=value`, одна пара на строку. Например, `R_DEFAULT_PACKAGES='utils,grDevices,graphics,stats'`. Фактически, это обычный текстовый файл с строгой структурой.


## Скрипты конфигурации .Rprofile
После загрузки переменных окружения при старте R-сессии загружается файл конфигурации сессии, Rprofile.site / .Rprofile. Процесс схож с загрузкой переменных окружения: сначала поиск файла, задающего параметры сессии для всех пользователей рабочей станции в `R_PROFILE` или `R_HOME/etc/Rprofile.site`. Если файла нет, то сначала поиск файла `.Rprofile` продолжается в `R_PROFILE_USER` и папке проекта), и только потом в домашней папке пользователя. Эти файлы действуют на все сессии проекта или на все сессии пользователя соответственно.

Чаще всего используют `.Rprofile`-скрипты, так как лучшей практикой считается максимально сужать область действия файлов конфигураций сессии. Временами можно даже найти на тематических форумах треды (в частности, Stackoverflow), в которых пользователи делятся своими конфигурациями. В отличие от `.Renviron` скрипты `.Rprofile` содержат код на R, и могут включать в себя установку определенных опций,  объявление или вызов функций. В `.Rprofile` также можно объявить функции, которые будут выполняться при старте или при завершении работы - функции `.Start()` и `.Last()` соответственно. 

Вот так выглядит пример `Rprofile.site` из документации, где устанавливается репозиторий по умолчанию:
```{r 14-startup-R-3, eval=FALSE}
local({
    r <- getOption("repos")
    r["CRAN"] <- "https://cloud.r-project.org"
    options(repos = r)
})
```

Также пример из документации для `.Rprofile`. Здесь задается зерно для псевдослучайной генерации, опции отображения (количество колонок при выводе на печать, количество значимых знаков и нужно ли отображать маркеры значимости различий). Выражение `.First <- function() cat("\n   Welcome to R!\n\n")` задает печать в консоли сообщения `Welcome to R!` при загрузке сессии. Выражение `.Last <- function()  cat("\n   Goodbye!\n\n")` напечатает `Goodbye!` при завершении сессии:
```{r 14-startup-R-4, eval=FALSE}
options(width=65, digits=5)
options(show.signif.stars=FALSE)
setHook(packageEvent("grDevices", "onLoad"),
        function(...) grDevices::ps.options(horizontal=FALSE))
set.seed(1234)
.First <- function() cat("\n   Welcome to R!\n\n")
.Last <- function()  cat("\n   Goodbye!\n\n")
```

Несмотря на очевидную полезность `.Rprofile` (да и `.Renviron` тоже), использовать их необходимо осмотрительно. В частности, могут возникнуть проблемы с совместным использованием скриптов - если какой-то скрипт написан с учетом того, что в `.Rprofile` объявляются пользовательские функции, то в любой другой сессии, где нет такого же файла конфигурации сессии, скрипт работать не будет. Например, нередко в `.Rprofile` пишут объявление функций типа `%nin% <- function(x, y) !(x %in% y)` или выставляют опцию `options(stringsAsFactors = FALSE)`.

Обычно при создании скриптов конфигурации меняют то, что не влияет напрямую на работу скрипта, но может сделать жизнь проще. Типовые решения:

 - указывают ближайшее зеркало CRAN
 
 - меняют символ начала строки в консоли (как правило, c `>` на `>>` или `#`)
 
 - устанавливают опции отображения (количество значимых знаков для `print()`, запрет на отображение чисел в scientific-формате  и т.д.)

 - задают определенные действия при старте и завершении функции. Нередко при завершении сессии задают запись `sessionInfo()` в отдельный файл.
 
 - в редких случаях указывают загрузку частоиспользуемых пакетов и перегружают базовые функции. В частности, мне как-то приходилось переопределять и внедрять в `source()` элементы трассировки ошибок c помощью `traceback()`, а также кастомизировать цвет сообщений об ошибках.

Нередко рекомендуется все объявляемые `.Rprofile` функции сопровождать проверкой на то, каким образом предполагается выполнение, интерактивно в консоли или выполнением R-скрипта (через `source()` или `eval()`). Например:

```{r 14-startup-R-5, eval=FALSE}
# опция для всех процессов сессии, как интерактивных, так и неинтерактивных
options(repos = c(CRAN = "https://cran.rstudio.org"))

# только если работа ижет в интерактивном режиме
if (interactive()) {
  options(scipen = 999)
}
```


## Настройки сессии (options)
После выполнения скрипта конфигурации и происходит еще ряд скрыт от пользователя процедур - подгрузка объектов рабочего пространства из прошлой сессии, если она была (`.RData`); выполнение объявленной в файле конфигурации функции `.First()`; подгрузка базовых пакетов (функция `base::.First.sys()`), загрузка истории выполненных выражений в предыдущей сессии (`R_HISTFILE` или `.Rhistory`). Также при выполнении скрипта конфигурации сессии устанавливают опции (`options`) сессии. 

Как правило, с помощью опций задают парвила вычисления и отображения результатов. К наиболее наглядным примерам можно отнести опцию импорта строк как факторов, запрет на отображение чисел в scientific (экспоненциальном) формате или определенный формат десятичного разделителя. Значения по умолчанию выставляются при старте сессии, после импорта переменных окружения и скриптов конфигураций, при подключении базовых пакетов. При этом можно самостоятельно задать новые значения опций - в файле конфигурации, до старта сессии, или же в скрипте сразу во время работы. Можно также использовать и консоль, но потом можно легко забыть, что были заданы новые значения, и потом долго удивляться результатам.

Полный список опций можно получить с помощью функции `options()`, которая отдает список названий опций и их значений (значениями могут быть как строковые или численные параметры, так и объявление функций). Описание опций можно также получить в справке `help(options)`. Выведем список пакетов, которые подключаются при старте сессии, помимо `base`:
```{r 14-startup-R-6 }
options()$defaultPackages
```

Многие пакеты в R также имеют свой список опций. При подключении пакетов эти опции становятся видны в общем списке, как правило, с названием пакета в префиксе. Вот, например, какие опции появляются при подключении пакета для профилирования `data.table`:
```{r 14-startup-R-7 }
library(data.table)
options_names <- names(options())
options_names[grep('datatable', options_names)]
```

```{r 14-startup-R-8, include=FALSE}
library(profvis)
if (!interactive()) {
  options_names <- names(options())
  options_names[grep('profvis', options_names)]
}
```



Значение опции можно получить и с помощью функции `getOption()`. Обычно именно этот метод используется, когда надо обратиться к опциям, например, в аргументах функции:
```{r 14-startup-R-9 }
getOption('defaultPackages')
```

Опции меняются меняются с помощью все той же функции `options()`, где аргументом выступает название опции. Изменения в опциях действуют в рамках сессии, поэтому если в работе постоянно требуются какие-то определенные настройки, то есть смысл выносить их в скрипт конфигурации `.Rprofile`. 
```{r 14-startup-R-10 }
# по умолчанию используется экспоненциальное представление чисел
getOption('scipen')
print(12345679101112)

# меняем scientific-формат на обычный разрядный
options(scipen = 999)
getOption('scipen')
print(12345679101112)
```

## Информация о R-сессии
Очень часто приходится сохранять информацию, на какой машине были произведены те или иные расчеты, какой набор пакетов и их версий использовался. В частности, это очень помогает при расследовании, что пошло не так при выполнении задачи. Получить информацию о сессии можно с помощью функции `sessionInfo()`. Функция возвращает объект класса `sessionInfo`. При печати объекта выводится сводня информация о сессии - версия ОС и R, используемые библиотеки для линейной алгебры, параметры локали, подключенные пакеты. Формулировка `loaded via a namespace (and not attached)` означает, что пакеты подгружены, но пользователь не имеет возможности обращаться к этих пакетов напрямую, в отличие от функций других пакетов.
```{r 14-startup-R-11 }
sessionInfo()
```

Объект `sessionInfo` содержит более подробную информацию о сессии, в частности, о пакетах - название, имя автора пакета, зависимости, лицензия, версия билда, дата публикации и прочая детальная информация. 

```{r 14-startup-R-12 }
# посмотрим информацию о подгруженном пакете Rcpp
si <- sessionInfo()
str(si$loadedOnly$Rcpp)
```




